# 2026-02-17 Daily Notes

## Pipeline PR #5 (Daily Cadence)

**Focus:** RL Refinement After SFT - Residual Delta-Waypoint Learning (Option B)

### Changes

- **Added:** `training/rl/rl_refinement_stub.py` - RL refinement entry point for Option B
  - Action space = waypoint deltas (Option B from driving-first roadmap)
  - SFT waypoint model stays frozen; trains small delta head via PPO
  - Pattern: `final_waypoints = sft_waypoints + delta_head(z)`
  - Toy waypoint environment (kinematics) for testing
  - Writes artifacts under `out/`: `config.json`, `metrics.json`, `train_metrics.json`, `final.pt`
  - Supports loading SFT model checkpoint for production use

- **Key Components:**
  - `SFTWaypointWrapper`: Loads and freezes SFT checkpoint (or mock if unavailable)
  - `DeltaWaypointHead`: Small trainable network predicting corrections (H, 2) deltas
  - `PPOAgent`: PPO with GAE, value head, entropy bonus
  - `RLRefinementTrainer`: Full training loop with metrics and checkpointing
  - `ToyWaypointEnv`: Minimal 2D car environment for delta-waypoint RL

### Design Pattern

```
                    +------------------+
                    |   Frozen SFT     |
                    |   Waypoint Model |
                    +--------+---------+
                             |
                    [sft_waypoints] |
                             |         |
                             v         |
                    +--------+---------+
                    |    Delta Head    |
                    |  (trained by RL) |
                    +--------+---------+
                             |
                    [delta_waypoints] |
                             |         |
                             v         v
                    +--------+---------+
                    |       Sum       |
                    +--------+---------+
                             |
                    [final_waypoints]
```

### Usage

```bash
# Run smoke test (toy environment)
python -m training.rl.rl_refinement_stub \
  --out-dir out/rl_refinement/run_001 \
  --episodes 50 \
  --seed 42

# With SFT model initialization
python -m training.rl.rl_refinement_stub \
  --sft-model out/sft_waypoint_bc_torch_v0/model.pt \
  --out-dir out/rl_refinement/run_sft_init \
  --episodes 200 \
  --seed 42
```

### Output Artifacts

```
out/rl_refinement/run_001/
├── config.json          # Training configuration
├── metrics.json         # Evaluation metrics per eval_interval
├── train_metrics.json   # Full training summary
├── final.pt             # Final model checkpoint
└── checkpoints/         # Intermediate checkpoints
```

### Pipeline Integration

RL refinement stage after SFT:
```
Waymo episodes → SSL pretrain → waypoint BC (SFT) → RL refinement (delta head)
```

### Next Steps

- [ ] Run with real SFT checkpoint to verify loading works
- [ ] Compare RL-refined vs SFT-only performance on toy environment
- [ ] Add CARLA integration for real-world evaluation
- [ ] Implement GRPO for comparison with PPO

---

## Pipeline PR #8 (Daily Cadence)

**Focus:** CARLA Closed-Loop Waypoint BC Evaluation Script

### Changes

- **Added:** `training/eval/run_carla_closed_loop_eval.py` - Comprehensive closed-loop evaluation
  - WaypointBCModelWrapper for loading trained checkpoints
  - 5 evaluation scenarios: straight_clear, straight_cloudy, straight_night, straight_rain, turn_clear
  - ClosedLoopMetrics: route_completion, collisions, deviation tracking
  - ScenarioResult aggregation with success_rate, avg_route_completion
  - Smoke test for validation without CARLA server

- **Components:**
  - `ScenarioConfig`: weather, map, spawn/target points per scenario
  - `ClosedLoopMetrics`: episode-level closed-loop metrics
  - `ScenarioResult`: aggregated scenario results
  - `WaypointBCModelWrapper`: checkpoint loading and inference
  - `CARLAClosedLoopEvaluator`: vehicle control and episode running

### Pipeline Integration

Complete CARLA evaluation stage:
```
Waymo episodes → SSL pretrain → waypoint BC → CARLA eval
```

### Usage

```bash
# Smoke test (no CARLA required)
python -m training.eval.run_carla_closed_loop_eval --smoke

# Full evaluation with CARLA server
python -m training.eval.run_carla_closed_loop_eval \
  --checkpoint out/waypoint_bc/best_model.pt \
  --output-dir out/carla_closed_loop_eval

# Specific scenarios only
python -m training.eval.run_carla_closed_loop_eval \
  --checkpoint out/waypoint_bc/best_model.pt \
  --output-dir out/carla_eval_night \
  --scenarios straight_night
```

### Next Steps

- [ ] Run CARLA evaluation with trained checkpoint
- [ ] Compare offline ADE/FDE with closed-loop metrics
- [ ] Add collision/offroad detection sensors
