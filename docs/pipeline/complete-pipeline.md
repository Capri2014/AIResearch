# Complete Unified Training Pipeline

**Date:** 2026-02-16

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                           COMPLETE TRAINING PIPELINE                                       │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                 DATA LAYER                                           │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                              │   │
│  │  │   Waymo     │  │  Alpamayo   │  │  nuScenes   │                              │   │
│  │  │  Dataset    │  │   R1        │  │  Dataset    │                              │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                              │   │
│  │         └───────────────────┼───────────────────┘                                      │   │
│  │                             ▼                                                        │   │
│  │                    ┌────────────────┐                                                │   │
│  │                    │UnifiedDataset  │                                                │   │
│  │                    │ (unified.py)   │                                                │   │
│  │                    └────────┬───────┘                                                │   │
│  └────────────────────────────┼─────────────────────────────────────────────────────────┘   │
│                               │                                                              │
│                               ▼                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              PREPROCESSING                                          │   │
│  │                                                                                     │   │
│  │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐  │   │
│  │  │    SSL Encoder      │    │   CoT Generator     │    │  Data Augmentation │  │   │
│  │  │  (JEPA Pre-train)  │───▶│  (llm_cot_gen.py)  │    │                    │  │   │
│  │  │  pretrain/          │    │  - Rule-based      │    │  - Random crop    │  │   │
│  │  │  jeepa_masked...   │    │  - LLM-based       │    │  - Color jitter  │  │   │
│  │  │                     │    │  - Learned         │    │  - Flip          │  │   │
│  │  └──────────┬──────────┘    └──────────┬──────────┘    └─────────────────────┘  │   │
│  │             │                            │                                         │   │
│  │             │    ┌──────────────────────┘                                         │   │
│  │             ▼    ▼                                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                    UnifiedSample (unified_dataset.py)                          │  │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │  │   │
│  │  │  │ Images  │ │  State  │ │ Actions │ │  CoT   │ │  LiDAR  │              │  │   │
│  │  │  │ [B,C,H,W]│ │ [B,16]  │ │ [B,T,3] │ │ [B,L]  │ │ Points  │              │  │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘              │  │   │
│  │  └─────────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
│                               ▼                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                           MODEL ARCHITECTURE                                         │   │
│  │                                                                                     │   │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                          UNIFIED MODEL (UnifiedDrivingModel)                    │  │   │
│  │  │                                                                               │  │   │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │   │
│  │  │  │                        INPUT ENCODING                                     │ │  │   │
│  │  │  │                                                                         │ │  │   │
│  │  │  │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐            │ │  │   │
│  │  │  │   │ SSL Encoder │     │State Encoder│     │CoT Encoder  │            │ │  │   │
│  │  │  │   │  (JEPA)    │     │   (MLP)    │     │  (LSTM)    │            │ │  │   │
│  │  │  │   │            │     │             │     │             │            │ │  │   │
│  │  │  │   │[B,C,H,W]──▶│     │ [B,state_  │     │ [B,cot_    │            │ │  │   │
│  │  │  │   │            │     │    dim]     │     │    dim]    │            │ │  │   │
│  │  │  │   │    ↓       │     │    ↓       │     │    ↓       │            │ │  │   │
│  │  │  │   │ [B,embed]  │     │ [B,hidden] │     │ [B,cot_    │            │ │  │   │
│  │  │  │   │            │     │             │     │    hidden] │            │ │  │   │
│  │  │  │   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘            │ │  │   │
│  │  │  │          │                    │                    │                   │ │  │   │
│  │  │  │          └────────────────────┼────────────────────┘                   │ │  │   │
│  │  │  │                               ▼                                        │ │  │   │
│  │  │  │                      ┌───────────────┐                                  │ │  │   │
│  │  │  │                      │   FUSION      │                                  │ │  │   │
│  │  │  │                      │  (concat +    │                                  │ │  │   │
│  │  │  │                      │   linear)     │                                  │ │  │   │
│  │  │  │                      └───────┬───────┘                                  │ │  │   │
│  │  │  │                              │                                          │ │  │   │
│  │  │  └──────────────────────────────┼──────────────────────────────────────────┘ │  │   │
│  │  │                                 │                                            │  │   │
│  │  │                                 ▼                                            │  │   │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │   │
│  │  │  │                      COMPONENT HEADS                                   │ │  │   │
│  │  │  │                                                                         │ │  │   │
│  │  │  │   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   │ │  │   │
│  │  │  │   │  World Model   │   │  VLA Planner    │   │  Safety Layer   │   │ │  │   │
│  │  │  │   │                 │   │                 │   │                 │   │ │  │   │
│  │  │  │   │ RSSM Latent    │   │ Trajectory Head │   │ Collision       │   │ │  │   │
│  │  │  │   │ Dynamics       │   │ + Explanation   │   │ Checker         │   │ │  │   │
│  │  │  │   │                 │   │                 │   │                 │   │ │  │   │
│  │  │  │   │ [latent_z]     │   │ [B,T,waypts]  │   │ [safe_traj]    │   │ │  │   │
│  │  │  │   │    ↓           │   │    ↓           │   │    ↓           │   │ │  │   │
│  │  │  │   │ Imagi-         │   │ + Explain      │   │ Fallback       │   │ │  │   │
│  │  │  │   │ nation         │   │ (text)         │   │ Planner        │   │ │  │   │
│  │  │  │   └────────┬────────┘   └────────┬────────┘   └────────┬────────┘   │ │  │   │
│  │  │  │            │                     │                    │              │ │  │   │
│  │  │  │            │         ┌────────────┴────────────┐      │              │ │  │   │
│  │  │  │            │         │                         │      │              │ │  │   │
│  │  │  │            └─────────┼─────────────────────────┼──────┘              │ │  │   │
│  │  │  │                      ▼                         │                    │ │  │   │
│  │  │  │              ┌─────────────────┐               │                    │ │  │   │
│  │  │  │              │  Trajectory     │               │                    │ │  │   │
│  │  │  │              │  Decoder        │               │                    │ │  │   │
│  │  │  │              │                 │               │                    │ │  │   │
│  │  │  │              │ [B,T,3] ◀──────┴───────────────┘                    │ │  │   │
│  │  │  │              └────────┬────────┘                                    │ │  │   │
│  │  │  │                       │                                            │ │  │   │
│  │  │  └───────────────────────┼────────────────────────────────────────────┘ │  │   │
│  │  │                          │                                              │  │   │
│  │  └──────────────────────────┼──────────────────────────────────────────────┘  │   │
│  │                             │                                                   │   │
│  └─────────────────────────────┼───────────────────────────────────────────────────┘   │
│                                │                                                        │
│                                ▼                                                        │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              UNIFIED LOSS FUNCTION                                  │   │
│  │                                                                                    │   │
│  │    L_total = L_trajectory + λ₁·L_world_model + λ₂·L_safety + λ₃·L_explanation   │   │
│  │                                                                                    │   │
│  │    ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐            │   │
│  │    │ L_trajectory     │  │ L_world_model   │  │ L_safety         │            │   │
│  │    │ (MSE waypoints)  │  │ (RSSM KL +      │  │ (curvature +     │            │   │
│  │    │                  │  │  reconstruction)│  │  collision)     │            │   │
│  │    └──────────────────┘  └──────────────────┘  └──────────────────┘            │   │
│  │                                                                                    │   │
│  └───────────────────────────────────────────────────────────────────────────────────┘   │
│                                │                                                        │
│                                ▼                                                        │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              TRAINING STAGES                                       │   │
│  │                                                                                    │   │
│  │  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐     │   │
│  │  │   Stage 1   │   │   Stage 2   │   │   Stage 3   │   │   Stage 4   │     │   │
│  │  │   SFT Only   │   │  + CoT       │   │  + World    │   │  + RL       │     │   │
│  │  │              │   │  Reasoning   │   │  Model       │   │  (GRPO)     │     │   │
│  │  │ train simple │   │ train with   │   │ train latent │   │ train with  │     │   │
│  │  │ waypoint BC  │   │ reasoning    │   │ dynamics    │   │ rewards     │     │   │
│  │  │              │   │ traces       │   │ loss        │   │             │     │   │
│  │  │ λ: [1,0,0,0]│   │ λ: [1,0,0,1]│   │ λ: [1,1,0,0]│   │ λ: [1,0,1,0]│     │   │
│  │  └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘     │   │
│  │                                                                                    │   │
│  │  Stages can be combined: e.g., Stage 2+3: λ: [1,1,0,1]                            │   │
│  └───────────────────────────────────────────────────────────────────────────────────┘   │
│                                │                                                        │
│                                ▼                                                        │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐   │
│  │                            OPTIMIZER & SCHEDULER                                  │   │
│  │                                                                                    │   │
│  │    ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │    │                     AdamW Optimizer                                       │   │   │
│  │    │    lr: 1e-4, weight_decay: 0.01, betas: (0.9, 0.999)                   │   │   │
│  │    └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                    │                                              │   │
│  │                                    ▼                                              │   │
│  │    ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │    │                  Cosine Annealing LR (optional)                          │   │   │
│  │    │    T_max: 100 epochs, η_min: 1e-6                                       │   │   │
│  │    └─────────────────────────────────────────────────────────────────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────────────────┘   │
│                                │                                                        │
│                                ▼                                                        │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              EVALUATION                                           │   │
│  │                                                                                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐               │   │
│  │  │ Trajectory      │  │ World Model     │  │ Safety          │               │   │
│  │  │ Metrics         │  │ Metrics         │  │ Metrics         │               │   │
│  │  │                 │  │                 │  │                 │               │   │
│  │  │ ADE / FDE      │  │ Imagination    │  │ Collision       │               │   │
│  │  │ Miss Rate       │  │ Consistency    │  │ Rate            │               │   │
│  │  │ Success Rate    │  │ Reconstruction │  │ Off-Road       │               │   │
│  │  │                 │  │ Error          │  │ Rate            │               │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘               │   │
│  │                                                                                    │   │
│  │              ┌─────────────────────────────────────────────┐                    │   │
│  │              │        Checkpoint Selection (Best ADE)        │                    │   │
│  │              │        training_metrics.py                     │                    │   │
│  │              └─────────────────────────────────────────────┘                    │   │
│  └───────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

LEGEND:
═══════
[Tensor Shape]
│        Data Flow
▶        Processing
┌─┐      Component Boundary

STAGES:
══════
Stage 1: Pure SFT (Waypoint BC)
Stage 2: SFT + CoT Reasoning  
Stage 3: SFT + World Model
Stage 4: SFT + RL (GRPO)

LOSS WEIGHTS (λ):
═══════════════════
λ₁ = world_model_weight (default: 0.1)
λ₂ = safety_weight (default: 0.5)
λ₃ = explanation_weight (default: 0.1)

FILES:
══════
Data:       training/data/unified_dataset.py
SFT:        training/sft/train_waypoint_bc_cot.py
CoT:        training/sft/llm_cot_generator.py
RL:         training/rl/grpo_waypoint.py
WorldModel: training/models/world_model.py
VLA:        training/models/vla_planner.py
Safety:     training/models/safety_layer.py
Unified:    training/unified/trainer.py
Metrics:    training/sft/training_metrics.py
Eval:       training/eval/evaluator.py
```

**File Created:** `docs/pipeline/complete-pipeline.md`
